<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CONVERTIDOR AVISOS - CMM MULTIZONA</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(135deg, #001f3f, #013a63, #014f86);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Estilos para los nuevos botones de zona */
.selector-zona {
  text-align: center;
  margin-bottom: 20px;
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 15px;
  width: fit-content;
  margin: 0 auto 20px auto;
}

.btn-zona {
  background: transparent;
  border: 2px solid #90e0ef;
  color: #90e0ef;
  padding: 8px 15px;
  margin: 5px;
  cursor: pointer;
  border-radius: 50px;
  font-weight: bold;
  transition: 0.3s;
}

.btn-zona.active {
  background: #90e0ef;
  color: #001f3f;
}

#textoInforme {
  width: 80%;
  height: 150px;
  margin: 0 auto 20px auto;
  padding: 12px;
  display: block;
  border-radius: 10px;
  border: 2px solid #014f86;
}

#vistaPrevia {
  width: 216mm;
  min-height: 279.4mm; 
  background: #fff;
  color: #000;
  margin: 20px auto;
  padding: 2mm 25mm 50mm 25mm;
  font-family: Arial, sans-serif;
  font-size: 10pt;
  line-height: 1.3;
  text-align: justify;
  position: relative;
  box-sizing: border-box;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
}

.cabecera-contenedor {
  position: absolute;
  top: 12mm;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20mm;
  box-sizing: border-box;
}

.cabecera-izquierda {
  text-align: center;
  width: 55%;
  font-size: 10pt;
  line-height: 1.2;
  margin-left: -14mm;
}

.cabecera-titulo { font-weight: bold; text-transform: uppercase; font-size: 11pt; }

.cabecera-derecha img {
  width: 18mm;
  height: auto;
  margin-right: 5mm;
  margin-top: -5mm; 
}

.titulo-subrayado { 
  font-size: 12pt; 
  font-weight: bold;
  text-transform: uppercase;
  border-bottom: 2px solid #000;
  display: inline-block;
  margin: 25px 0;
  padding-bottom: 2px;
}

.pie-pagina-folio {
  position: absolute;
  bottom: 15mm;
  right: 25mm;
  width: auto;
  text-align: right;
  font-size: 10pt;
  color: #000;
}

.enlace { color: #0000EE; text-decoration: underline; font-weight: 500; }
.peque { font-size: 10pt; font-weight: bold; text-transform: uppercase; }

footer {
  text-align: center;
  padding: 30px 10px;
  color: #e0e0e0;
  font-size: 14px;
  margin-top: auto;
}

footer span { font-weight: bold; color: #90e0ef; }

.controles {
  text-align: center;
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 15px;
  width: fit-content;
  margin: 0 auto 20px auto;
}

button {
  padding: 12px 20px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  margin: 5px;
  transition: 0.3s;
}

.btn-vista { background: #00b4d8; color: #001f3f; }
.btn-carta { background: #4caf50; color: white; }
.btn-folio { background: #e63946; color: white; }

button:hover { opacity: 0.8; transform: scale(1.05); }

b { font-weight: bold !important; }
</style>
</head>

<body>

<h1 style="text-align:center; color:white; text-transform:uppercase; margin-top:20px;">Generador de Avisos Multizona</h1>

<div class="selector-zona">
    <button class="btn-zona" onclick="cambiarJurisdiccion('iqq', this)">IQUIQUE</button>
    <button class="btn-zona" onclick="cambiarJurisdiccion('valpo', this)">VALPARA칈SO</button>
    <button class="btn-zona" onclick="cambiarJurisdiccion('tal', this)">TALCAHUANO</button>
    <button class="btn-zona active" onclick="cambiarJurisdiccion('pmo', this)">PUERTO MONTT</button>
    <button class="btn-zona" onclick="cambiarJurisdiccion('pnt', this)">PUNTA ARENAS</button>
</div>

<textarea id="textoInforme" placeholder="Pegue el texto del aviso aqu칤..."></textarea>

<div class="controles">
  <input type="text" id="nombrePDF" placeholder="Nombre del archivo" style="padding:10px; width:200px; border-radius:5px; border:1px solid #ccc; margin-bottom:10px;">
  <br>
  <button class="btn-vista" onclick="generarVista()">游댌 Actualizar Vista Previa</button>
  <button class="btn-carta" onclick="generarPDF('letter')">游늯 Descargar CARTA</button>
  <button class="btn-folio" onclick="generarPDF([216, 330])">游늯 Descargar OFICIO</button>
</div>

<div id="vistaPrevia">
    <div class="cabecera-contenedor">
        <div class="cabecera-izquierda" id="cabeceraDinamica">
            <div class="cabecera-titulo">Armada de Chile</div>
            <div>Comandante en Jefe V Zona Naval</div>
            <div>Gobernaci칩n Mar칤tima de Puerto Montt</div>
            <div>Centro Meteorol칩gico Mar칤timo PMO.</div>
        </div>
        <div class="cabecera-derecha">
            <img src="https://archive.org/download/logo-servimet-transparente/LOGO_SERVIMET_TRANSPARENTE.png" alt="Escudo">
        </div>
    </div>

    <div id="contenidoPagina" style="margin-top:30mm;"></div>

    <div class="pie-pagina-folio" id="pieDinamico">
        <div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE PUERTO MONTT</div>
        <div class="cabecera-sub">
            <span class="enlace">http://meteoarmada.directemar.cl</span> // 
            <span class="enlace">@MetArmada_Pmo</span>
        </div>
        <div class="cabecera-sub">AVENIDA ANGELM칍 2201, PUERTO MONTT</div>
        <div class="cabecera-sub">TEL: (65) 2205174 - 2205123</div>
    </div>
</div>

<footer>
  Creado por <span>Cabo 1췈 (Met.) Francisco Salas Mu침oz</span>
</footer>

<script>
// Base de datos para el cambio de cabeceras
const datosJurisdiccion = {
    iqq: {
        cab: `<div class="cabecera-titulo">Armada de Chile</div><div>Comandancia en Jefe IV Zona Naval</div><div>Gobernaci칩n Mar칤tima de Iquique</div><div>Centro Meteorol칩gico Mar칤timo de Iquique</div>`,
        pie: `<div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE IQUIQUE</div><div class="cabecera-sub"><span class="enlace">http://meteoarmada.directemar.cl</span> // <span class="enlace">@MetArmada_Iqq</span></div><div class="cabecera-sub">JORGE BARRERA S/N, IQUIQUE</div><div class="cabecera-sub">TEL: (57) 2401947</div>`
    },
    valpo: {
        cab: `<div class="cabecera-titulo">Armada de Chile</div><div>Comandancia en Jefe l Zona Naval</div><div>Gobernaci칩n Mar칤tima de Valpara칤so</div><div>Centro Meteorol칩gico Mar칤timo de Valpara칤so. </div>`,
        pie: `<div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE VALPARA칈SO</div><div class="cabecera-sub"><span class="enlace">http://meteoarmada.directemar.cl</span> // <span class="enlace">@MetArmada_Valp</span></div><div class="cabecera-sub">SUBIDA LEOPOLDO CARVALLO 150, PLAYA ANCHA</div><div class="cabecera-sub">TEL: (32) 2208965 - 2208914</div>`
    },
    tal: {
        cab: `<div class="cabecera-titulo">Armada de Chile</div><div>Comandancia en Jefe II Zona Naval</div><div>Gobernaci칩n Mar칤tima de Talcahuano</div><div>Centro Meteorol칩gico Mar칤timo de Talcahuano</div>`,
        pie: `<div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE TALCAHUANO</div><div class="cabecera-sub"><span class="enlace">http://meteoarmada.directemar.cl</span> // <span class="enlace">@MetArmada_Thno</span></div><div class="cabecera-sub"> ALMIRANTE VILLARROEL 107, TALCAHUANO</div><div class="cabecera-sub"> TEL: (41) 3831157 -  3831100</div>`
    },
    pmo: {
        cab: `<div class="cabecera-titulo">Armada de Chile</div><div>Comandante en Jefe V Zona Naval</div><div>Gobernaci칩n Mar칤tima de Puerto Montt</div><div>Centro Meteorol칩gico Mar칤timo de Puerto Montt.</div>`,
        pie: `<div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE PUERTO MONTT</div><div class="cabecera-sub"><span class="enlace">http://meteoarmada.directemar.cl</span> // <span class="enlace">@MetArmada_Pmo</span></div><div class="cabecera-sub">AVENIDA ANGELM칍 2201, PUERTO MONTT</div><div class="cabecera-sub">TEL: (65) 2205174 - 2205123</div>`
    },
    pnt: {
        cab: `<div class="cabecera-titulo">Armada de Chile</div><div>Comandante en Jefe III Zona Naval</div><div>Gobernaci칩n Mar칤tima de Punta Arenas</div><div>Centro Meteorol칩gico Mar칤timo de</div>Magallanes y Ant치rtica Chilena</div>`,
        pie: `<div class="cabecera-sub peque">CENTRO METEOROL칍GICO MAR칈TIMO DE MAGALLANES</div><div class="cabecera-sub"><span class="enlace">http://meteoarmada.directemar.cl</span> // <span class="enlace">@MetArmada_Mag</span></div><div class="cabecera-sub">AV. O'HIGGINS 1169, PUNTA ARENAS</div><div class="cabecera-sub">TEL: (61) 2201138 - +56977483132</div>`
    }
};

function cambiarJurisdiccion(id, btn) {
    // Cambiar texto
    document.getElementById('cabeceraDinamica').innerHTML = datosJurisdiccion[id].cab;
    document.getElementById('pieDinamico').innerHTML = datosJurisdiccion[id].pie;
    
    // Cambiar estado de botones
    document.querySelectorAll('.btn-zona').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Actualizar vista si hay texto
    generarVista();
}

function todoMayusculas(texto) { return texto.toUpperCase(); }

function aplicarNegritasEspeciales(html) {
    html = html.replace(/(A\.-[^<]*(\.|$|<br>))/g, "<b>$1</b>");
    html = html.replace(/(D\.-[^<]*(\.|$|<br>))/g, "<b>$1</b>");
    html = html.replace(/(B\.-[\s\S]*?:)/g, "<b>$1</b>");
    html = html.replace(/(C\.-[\s\S]*?:)/g, "<b>$1</b>");
    html = html.replace(/(SECTOR[^\n<]+)/g, "<b>$1</b>");
    const regexTramos = /(^|<br>|(?<=\.\s))([A-Z칌츼칄칈칍칔\s]+ A [A-Z칌츼칄칈칍칔\s]+(\:|\.))/g;
    html = html.replace(regexTramos, "$1<b>$2</b>");
    html = html.replace(/([A-Z칌츼칄칈칍칔\s]{4,}:)/g, "<b>$1</b>");
    html = html.replace(/(NOTAS?:)/g, "<b>$1</b>");
    html = html.replace(/(EMITIDO:)/g, "<b>$1</b>");
    html = html.replace(/(MET\d+\w+ \d+\/\w+)/g, "<b>$1</b>");
    const regexDias = /((?:LUNES|MARTES|MIERCOLES|MI칄RCOLES|JUEVES|VIERNES|SABADO|S츼BADO|DOMINGO)\s\d{1,2}(?:\:|\.(?!\d)))/g;
    html = html.replace(regexDias, "<b>$1</b>");
    html = html.replace(/(,\s*)<b>([^<]+)<\/b>/g, "$1$2");
    html = html.replace(/<b>INTENSIDAD MAXIMA DE VIENTO ESPERADA POR BAHIA:<\/b>/g, "INTENSIDAD MAXIMA DE VIENTO ESPERADA POR BAHIA:");
    html = html.replace(/<b>RIZADA A MAREJADILLA\.<\/b>/g, "RIZADA A MAREJADILLA.");
    html = html.replace(/<b>RIZADA A MAREJADILLA<\/b>/g, "RIZADA A MAREJADILLA");
    return html;
}

function generarVista(){
    const areaTexto = document.getElementById("textoInforme").value.trim();
    if(!areaTexto) return;
    const textoMayus = todoMayusculas(areaTexto);
    const lineas = textoMayus.split("\n");
    const titulo = `<div style="text-align:center;"><span class="titulo-subrayado">${lineas[0]}</span></div>`;
    const cuerpo = lineas.slice(1).join("\n").replace(/\n/g, "<br>");
    const cuerpoConNegritas = aplicarNegritasEspeciales(cuerpo);
    document.getElementById("contenidoPagina").innerHTML = titulo + "<div style='height:15px;'></div>" + cuerpoConNegritas;
}

async function generarPDF(formatoSeleccionado) {
    const { jsPDF } = window.jspdf;
    const elemento = document.getElementById("vistaPrevia");
    elemento.style.minHeight = (formatoSeleccionado === 'letter') ? "279.4mm" : "330mm";

    const canvas = await html2canvas(elemento, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
    const imgData = canvas.toDataURL("image/jpeg", 0.8);
    const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: formatoSeleccionado, compress: true });

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

    pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, Math.min(imgHeight, pdfHeight), undefined, 'FAST');
    const sufijo = (formatoSeleccionado === 'letter') ? "_Carta" : "_Oficio";
    pdf.save((document.getElementById("nombrePDF").value.trim() || "Aviso_Meteorologico") + sufijo + ".pdf");
}
</script>
</body>
</html>
